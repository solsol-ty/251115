<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ì›Œë“œí´ë¼ìš°ë“œ</title>

  <link href="https://cdn.jsdelivr.net/gh/orioncactus/pretendard/dist/web/static/pretendard.css" rel="stylesheet" />

  <style>
    body { 
      margin: 0; 
      background-color: #ffeef4; 
      background-image: none;
      color: #333;
      font-family: "Pretendard", "Noto Sans KR", system-ui, sans-serif;
      overflow: hidden;
    }
    #cloud { width: 100vw; height: 100vh; }
    .hint {
      position: fixed;
      top: 10px;
      left: 14px;
      font-size: 12px;
      opacity: .6;
      color: #555;
    }
  </style>
</head>
<body>
  <div class="hint">ì‹¤ì‹œê°„ ì›Œë“œí´ë¼ìš°ë“œ (3ì´ˆ ê°„ê²© ì—…ë°ì´íŠ¸)</div>
  <div id="cloud"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/d3-cloud/1.2.7/d3.layout.cloud.min.js"></script>

  <script>
    const WEB_APP_URL = "https://script.google.com/macros/s/AKfycbyyS5sUtVM5_WroW-FO7wFEpivso_sz4A8j3WXCLB1V82XqtfZiy_rhu3CFthdMXYTn/exec";
    const container = document.getElementById('cloud');
    let svg, g, lastData = [];

    function initSVG() {
      container.innerHTML = '';
      const w = window.innerWidth, h = window.innerHeight;
      svg = d3.select(container).append('svg').attr('width', w).attr('height', h);
      g = svg.append('g').attr('transform', `translate(${w/2},${h/2})`);
    }

    function preprocess(list) {
      const freq = new Map();
      for (const item of list) {
        const text = (item.text || '').trim();
        if (!text) continue;
        const key = text.toLowerCase();
        const prev = freq.get(key) || { text, count: 0 };
        prev.count += 1;
        prev.text = text;
        freq.set(key, prev);
      }
      return Array.from(freq.values()).sort((a, b) => b.count - a.count);
    }

    function drawCloud(data) {
      initSVG();
      const w = window.innerWidth, h = window.innerHeight;
      if (!data.length) return;
      const maxCount = d3.max(data, d => d.count) || 1;
      const sizeScale = d3.scaleLinear().domain([1, maxCount]).range([45, 110]);
      const words = data.map(d => ({ text: d.text, size: sizeScale(d.count) }));
      const palette = ["#368dd2","#00a7c2","#da4133","#b39b96","#e35d7d","#f6da76"];

      const layout = d3.layout.cloud()
        .size([w, h])
        .words(words)
        // ğŸ”’ ê²¹ì¹¨ ë°©ì§€: ê¸€ì í¬ê¸°ì— ë¹„ë¡€í•œ padding
        .padding(d => Math.max(6, Math.floor(d.size * 0.18)))
        .rotate(() => Math.random() < 0.85 ? 0 : 90)
        .font("Pretendard")
        .fontSize(d => d.size)
        .spiral("archimedean")
        .on("end", out => {
          g.selectAll("text").data(out).enter().append("text")
            .style("font-size", d => d.size + "px")
            .style("fill", () => palette[Math.floor(Math.random()*palette.length)])
            .style("font-weight", 700)
            .attr("text-anchor", "middle")
            // âš ï¸ ê²¹ì¹¨ ë°©ì§€ë¥¼ ìœ„í•´ ë ˆì´ì•„ì›ƒì´ ê³„ì‚°í•œ ì¢Œí‘œë¥¼ ê·¸ëŒ€ë¡œ ì‚¬ìš©í•©ë‹ˆë‹¤.
            .attr("transform", d => `translate(${d.x},${d.y})rotate(${d.rotate})`)
            .text(d => d.text);
        });
      layout.start();
    }

    async function fetchData() {
      try {
        const res = await fetch(WEB_APP_URL + "?mode=all&event=event1", { cache: 'no-store', mode: 'cors' });
        const json = await res.json();
        if (json && json.ok && Array.isArray(json.data)) {
          lastData = json.data;
          drawCloud(preprocess(lastData));
        }
      } catch (e) { console.error(e); }
    }

    fetchData();
    setInterval(fetchData, 3000);
    window.addEventListener('resize', () => drawCloud(preprocess(lastData)));
  </script>
</body>
</html>
